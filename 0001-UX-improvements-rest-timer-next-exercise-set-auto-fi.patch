From f1443f209f2a72e2140c104cfaf2a47e7927365f Mon Sep 17 00:00:00 2001
From: Claude <claude@talos.fit>
Date: Wed, 18 Feb 2026 00:00:34 +0000
Subject: [PATCH] UX improvements: rest timer next exercise, set auto-fill, RIR
 0 fix, history AI review

- Rest timer modal: shows 'Up Next' with exercise name and set number
  where 'Rest' label used to be; 'REST' moved inside the ring above countdown
- Auto-fill: completing set 1 propagates weight/reps to subsequent empty
  sets so you can just tap-and-edit instead of re-entering
- RIR 0 bug: fixed falsy 0 handling in select value (set.rpe || '' treats
  0 as empty); now uses explicit null/empty checks
- AI review on history: added 'Get AI Review' button in expanded workout
  cards for workouts without an existing review
---
 src/components/RestTimer.jsx | 26 +++++++++----
 src/pages/ActiveWorkout.jsx  | 45 +++++++++++++++++++---
 src/pages/HistoryPage.jsx    | 73 +++++++++++++++++++++++++++++++++++-
 3 files changed, 130 insertions(+), 14 deletions(-)

diff --git a/src/components/RestTimer.jsx b/src/components/RestTimer.jsx
index a2ba94c..411d80b 100644
--- a/src/components/RestTimer.jsx
+++ b/src/components/RestTimer.jsx
@@ -18,7 +18,7 @@ const RING_STROKE = 8;
 const RING_RADIUS = (RING_SIZE - RING_STROKE) / 2;
 const RING_CIRCUMFERENCE = 2 * Math.PI * RING_RADIUS;
 
-export default function RestTimer({ seconds: initialSeconds, onDone, onCancel }) {
+export default function RestTimer({ seconds: initialSeconds, nextInfo, onDone, onCancel }) {
   const [total, setTotal] = useState(initialSeconds);
   const [remaining, setRemaining] = useState(initialSeconds);
   const [done, setDone] = useState(false);
@@ -87,16 +87,23 @@ export default function RestTimer({ seconds: initialSeconds, onDone, onCancel })
         textAlign: "center",
         animation: done ? "restDonePulse 0.6s ease-out" : undefined,
       }}>
-        {/* Label */}
+        {/* Label — show next exercise/set or fallback */}
         <div style={{
-          fontSize: 11,
+          fontSize: nextInfo ? 12 : 11,
           fontWeight: 700,
-          letterSpacing: "1.5px",
-          textTransform: "uppercase",
-          color: done ? "#22c55e" : "var(--text-muted)",
+          letterSpacing: nextInfo ? "0.3px" : "1.5px",
+          textTransform: nextInfo ? "none" : "uppercase",
+          color: done ? "#22c55e" : "var(--text-bright)",
           marginBottom: 16,
         }}>
-          {done ? "✓ Time's Up" : "Rest"}
+          {done ? "✓ Time's Up" : nextInfo
+            ? <>
+                <span style={{ fontSize: 9, fontWeight: 500, letterSpacing: "1px", textTransform: "uppercase", color: "var(--text-dim)", display: "block", marginBottom: 3 }}>Up Next</span>
+                {nextInfo.exercise}
+                <span style={{ fontSize: 10, fontWeight: 500, color: "var(--text-muted)", marginLeft: 6 }}>Set {nextInfo.set}/{nextInfo.totalSets}</span>
+              </>
+            : "Rest"
+          }
         </div>
 
         {/* Circular progress ring */}
@@ -144,6 +151,11 @@ export default function RestTimer({ seconds: initialSeconds, onDone, onCancel })
             alignItems: "center",
             justifyContent: "center",
           }}>
+            {!done && (
+              <div style={{ fontSize: 8, fontWeight: 700, letterSpacing: "1.5px", textTransform: "uppercase", color: "var(--text-dim)", marginBottom: 2 }}>
+                REST
+              </div>
+            )}
             <div style={{
               fontSize: 42,
               fontWeight: 800,
diff --git a/src/pages/ActiveWorkout.jsx b/src/pages/ActiveWorkout.jsx
index 6fa2094..b6e41e8 100644
--- a/src/pages/ActiveWorkout.jsx
+++ b/src/pages/ActiveWorkout.jsx
@@ -36,17 +36,49 @@ export default function ActiveWorkout({ workout, setWorkout, onFinish, onDiscard
   }
 
   function toggleSet(ei, si) {
+    const wasCompleted = workout.exercises[ei].sets[si].completed;
     setWorkout(p => {
       const n = JSON.parse(JSON.stringify(p));
-      const was = n.exercises[ei].sets[si].completed;
-      n.exercises[ei].sets[si].completed = !was;
+      n.exercises[ei].sets[si].completed = !wasCompleted;
+      // Auto-fill: when completing a set, propagate weight/reps to subsequent empty sets
+      if (!wasCompleted) {
+        const completedSet = n.exercises[ei].sets[si];
+        const sets = n.exercises[ei].sets;
+        for (let s = si + 1; s < sets.length; s++) {
+          if (!sets[s].completed) {
+            if ((sets[s].weight === "" || sets[s].weight === undefined || sets[s].weight === null) && completedSet.weight) {
+              sets[s].weight = completedSet.weight;
+            }
+            if ((sets[s].reps === "" || sets[s].reps === undefined || sets[s].reps === null) && completedSet.reps) {
+              sets[s].reps = completedSet.reps;
+            }
+          }
+        }
+      }
       return n;
     });
-    if (!workout.exercises[ei].sets[si].completed && profile.restTimerEnabled !== false) {
+    if (!wasCompleted && profile.restTimerEnabled !== false) {
       const ex = workout.exercises[ei];
       const isCompound = EXERCISES.find(e => e.name === ex.name)?.type === "compound";
       const secs = isCompound ? (profile.restTimerCompound || 150) : (profile.restTimerIsolation || 90);
-      setRestTimer(secs);
+      // Determine what's next: next incomplete set in same exercise, or next exercise
+      let nextInfo = null;
+      const currentSets = ex.sets;
+      const nextSetIdx = currentSets.findIndex((s, idx) => idx > si && !s.completed);
+      if (nextSetIdx !== -1) {
+        nextInfo = { exercise: ex.name, set: nextSetIdx + 1, totalSets: currentSets.length };
+      } else {
+        // Look for next exercise with incomplete sets
+        for (let e = ei + 1; e < workout.exercises.length; e++) {
+          const nextEx = workout.exercises[e];
+          const firstIncomplete = nextEx.sets.findIndex(s => !s.completed);
+          if (firstIncomplete !== -1) {
+            nextInfo = { exercise: nextEx.name, set: firstIncomplete + 1, totalSets: nextEx.sets.length };
+            break;
+          }
+        }
+      }
+      setRestTimer({ seconds: secs, nextInfo });
     }
   }
 
@@ -251,7 +283,7 @@ export default function ActiveWorkout({ workout, setWorkout, onFinish, onDiscard
                 <div style={{ fontSize: 10, color: "var(--text-dim)", fontWeight: 700, textAlign: "center" }}>{si + 1}</div>
                 <input type="number" inputMode="decimal" value={set.weight} onChange={e => updateSet(ei, si, "weight", e.target.value ? Number(e.target.value) : "")} onFocus={e => e.target.select()} style={S.smInput} placeholder="—" />
                 <input type="number" inputMode="numeric" value={set.reps} onChange={e => updateSet(ei, si, "reps", e.target.value ? Number(e.target.value) : "")} onFocus={e => e.target.select()} style={S.smInput} placeholder="—" />
-                <select value={set.rpe || ""} onChange={e => updateSet(ei, si, "rpe", e.target.value ? Number(e.target.value) : "")} style={S.smSelect}>
+                <select value={set.rpe != null && set.rpe !== "" ? set.rpe : ""} onChange={e => updateSet(ei, si, "rpe", e.target.value !== "" ? Number(e.target.value) : "")} style={S.smSelect}>
                   {scaleOptions.map(v => <option key={v} value={v}>{v === "" ? "—" : v}</option>)}
                 </select>
                 <button onClick={() => toggleSet(ei, si)} style={S.check(set.completed)}>{set.completed ? "✓" : ""}</button>
@@ -285,7 +317,8 @@ export default function ActiveWorkout({ workout, setWorkout, onFinish, onDiscard
       {/* Rest timer modal (overlays screen when active) */}
       {restTimer && (
         <RestTimer
-          seconds={restTimer}
+          seconds={restTimer.seconds}
+          nextInfo={restTimer.nextInfo}
           onDone={() => setRestTimer(null)}
           onCancel={() => setRestTimer(null)}
         />
diff --git a/src/pages/HistoryPage.jsx b/src/pages/HistoryPage.jsx
index 710b069..aa933f5 100644
--- a/src/pages/HistoryPage.jsx
+++ b/src/pages/HistoryPage.jsx
@@ -5,8 +5,9 @@
 
 import { useState, useMemo } from "react";
 import { useTalos } from "../context/TalosContext";
-import { fmtDate, FEEL } from "../lib/helpers";
+import { fmtDate, FEEL, est1RM } from "../lib/helpers";
 import MarkdownText from "../components/MarkdownText";
+import api from "../lib/api";
 import S from "../lib/styles";
 
 // ── Generic color palette ──
@@ -341,6 +342,9 @@ export default function HistoryPage({ onLogPast }) {
                 {hasReview && (
                   <ReviewSection review={workoutReviews[w.id]} />
                 )}
+                {!hasReview && aiConfig.enabled && (
+                  <RequestReviewButton workout={w} />
+                )}
                 <div style={{ display: "flex", gap: 8, marginTop: 10 }}>
                   <button onClick={() => repeatWorkout(w)} style={{ ...S.sm(), flex: 1, color: "var(--accent)", borderColor: "var(--accent-bg2)" }}>Repeat</button>
                   <button onClick={() => editWorkout(w)} style={{ ...S.sm("ghost"), flex: 1 }}>Edit</button>
@@ -407,3 +411,70 @@ function ReviewSection({ review }) {
     </div>
   );
 }
+
+// ── Request AI review from history ──
+function RequestReviewButton({ workout }) {
+  const { workouts, user, profile, programs, setWorkoutReviews } = useTalos();
+  const [loading, setLoading] = useState(false);
+  const [error, setError] = useState(null);
+
+  async function requestReview() {
+    setLoading(true);
+    setError(null);
+    try {
+      const prevWorkouts = workouts.filter(w => w.id !== workout.id);
+      const recent = prevWorkouts.slice(-5);
+      const prs = {};
+      prevWorkouts.forEach(w => w.exercises?.forEach(ex => ex.sets?.forEach(s => {
+        if (!s.weight || !s.reps) return;
+        const e = est1RM(parseFloat(s.weight), parseInt(s.reps));
+        if (!prs[ex.name] || (e && e > (prs[ex.name].e1rm || 0)))
+          prs[ex.name] = { weight: s.weight, reps: s.reps, e1rm: e, date: w.date };
+      })));
+
+      const profileLines = [
+        `Name: ${user.name}`,
+        profile.experienceLevel ? `Experience: ${profile.experienceLevel}` : null,
+        profile.goal ? `Goal: ${profile.goal}` : null,
+        profile.weight ? `Weight: ${profile.weight} lbs` : null,
+        profile.injuriesNotes ? `Injuries: ${profile.injuriesNotes}` : null,
+      ].filter(Boolean).join(", ");
+
+      const context = `USER: ${profileLines}
+PRs:\n${Object.entries(prs).slice(0, 15).map(([k, v]) => `${k}: ${v.weight}x${v.reps} (e1RM: ${v.e1rm || "?"})`).join("\n")}
+RECENT (${recent.length}):\n${recent.map(w => `${w.date} ${w.day_label || ""} (Feel:${w.feel}/5)\n${w.exercises?.map(e => `  ${e.name}: ${e.sets?.map(s => `${s.weight}x${s.reps}`).join(", ")}`).join("\n") || ""}`).join("\n\n")}`;
+
+      const res = await api.post("/coach/analyze", {
+        workout,
+        context,
+        workout_id: workout.id,
+      });
+
+      setWorkoutReviews(prev => ({ ...prev, [workout.id]: res.analysis }));
+    } catch (e) {
+      console.error("Review error:", e);
+      setError("Failed to generate review");
+    } finally {
+      setLoading(false);
+    }
+  }
+
+  return (
+    <div style={{ marginTop: 10, borderTop: "1px solid var(--surface2)", paddingTop: 8 }}>
+      {error ? (
+        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
+          <span style={{ fontSize: 10, color: "#ef4444" }}>{error}</span>
+          <button onClick={requestReview} style={{ ...S.sm("ghost"), fontSize: 9 }}>Retry</button>
+        </div>
+      ) : loading ? (
+        <div style={{ fontSize: 10, color: "var(--accent)", textAlign: "center", padding: 4 }}>
+          Analyzing session...
+        </div>
+      ) : (
+        <button onClick={requestReview} style={{ ...S.sm(), width: "100%", color: "var(--accent)", borderColor: "var(--accent-bg2)", display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>
+          <span>⚡</span> Get AI Review
+        </button>
+      )}
+    </div>
+  );
+}
-- 
2.43.0

